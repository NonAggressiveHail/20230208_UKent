#!bin/bash

##################################
# Help()
##################################

Help()
{
	# Display Help
	echo 
	echo "Identifies the core genome in a selection of fasta files and"
	echo "produces a phylogenetic tree of it using anvi'o"
	echo 
	echo "options:"
	echo "  -h  display this help"
	echo "  -g  directory genomes are in"
	echo "  -c  do genomes need decompressing?"
	echo "  -n  number of threads to use for parallel processing"
	echo "  -o directory to output results in"
	echo
	echo "Author: Jake Hudson"
	echo
}

#################################
# Setup
#################################
n_cpu=1
decompress=FALSE

#################################
# Process input options
#################################

# Get Options
while getopts ":hg:c:n:o:" option;
do
	case $option in
		h) # Display help
		  Help
		  exit;;
		g) # Directory genomes are in
		  gene_dir=$OPTARG;;
		c) # Do genomes need decompressing?
		  decompress=TRUE;;
		n) # Number of CPUs available
		  n_cpu=$OPTARG;;
		o) # output location
		  out_dir=$OPTARG;;
		\?) #Invalid option
			echo "Error: Invalid option"
			Help
			exit;;
		esac
done

###############################
# Main Program
###############################

# decompress files if needed
if [ decompress=TRUE ] 
  then
    
    echo "Decompressing"

    find $gene_dir -mindepth 1 -maxdepth 1 -type d |
      parallel -j $n_cpu 'gzip -d {}/{/}_genomic.fna.gz'

    echo "Done!"

fi

# Reformat fasta files so anvio is happy with them
echo "Reformatting files"
find $gene_dir -mindepth 1 -maxdepth 1 -type d | 
  parallel -j $n_cpu 'anvi-script-reformat-fasta {}/{/}_genomic.fna \
                                                 -o {}/{/}_genomic_fixed.fna'

# convert files into contigs.db files as this is the format anvio wants
echo "Converting to contigs.db files"
find $gene_dir -mindepth 1 -maxdepth 1 -type d | 
  parallel -j $n_cpu 'anvi-gen-contigs-database -f {}/{/}_genomic_fixed.fna \
                                                -o {}/{/}_genomic.db -T 1'
echo "Done!"

# find hmms in contigs .db files
# I'm not sure why we do this but its in the tutorial
echo "Finding hmms in contigs.db files"
find $gene_dir -mindepth 1 -maxdepth 1 -type d | 
  parallel -j $n_cpu 'anvi-run-hmms -c {}/{/}_genomic.db'
echo "Done!"

# make file which says where the genomes are (anvi'o needs this later)
echo "Making gene map file"
echo "name\tcontigs_db_path\n" > ${out_dir}genome_map.txt

for dir in $(find $gene_dir -mindepth 1 -maxdepth 1 -type d)
do
  
  name="$(basename $FILE)"

  echo "${name}\t${dir}/${name}/${name}_genomic.db\n" >> ${out_dir}genome_map.txt

done

echo "Done!"


